#!/usr/bin/env node

/**
 * BSG Users Report by Applications
 * Generates comprehensive user access report organized by BSG applications
 */

const axios = require('axios');
const jwt = require('jsonwebtoken');
const fs = require('fs');

const baseURL = 'http://localhost:3001';
const JWT_SECRET = process.env.JWT_SECRET || 'VERY_VERY_VERY_SECRET_KEY';

// Create admin token
function createAdminToken() {
    const payload = {
        id: 1,
        role: 'admin',
        email: 'admin@bsg.co.id',
        departmentId: 1,
        unitId: 1,
        username: 'admin',
        isBusinessReviewer: true
    };
    
    return jwt.sign(payload, JWT_SECRET, { expiresIn: '1h' });
}

// Generate User Access Summary Report
async function generateUserAccessSummary() {
    console.log('üìä Generating BSG Users by Applications Report');
    console.log('===============================================\n');
    
    const token = createAdminToken();
    const headers = {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    };
    
    try {
        // Get user access summary
        console.log('üîç Fetching user access data...');
        const response = await axios.get(`${baseURL}/api/reports/user-access-summary`, { headers });
        
        if (response.status === 200 && response.data.success) {
            const reportData = response.data.data;
            
            console.log('üìà BSG USER ACCESS SUMMARY REPORT');
            console.log('Generated:', new Date().toLocaleString());
            console.log('====================================\n');
            
            // Overall summary
            console.log('üìä OVERALL SUMMARY:');
            console.log(`   ‚Ä¢ Total Applications: ${reportData.summary.totalApplications}`);
            console.log(`   ‚Ä¢ Total User Requests: ${reportData.summary.totalUserRequests}`);
            console.log(`   ‚Ä¢ Pending Approvals: ${reportData.summary.pendingApprovals}`);
            console.log(`   ‚Ä¢ Active Requests: ${reportData.summary.activeRequests}\n`);
            
            // Application breakdown
            if (reportData.applicationBreakdown && reportData.applicationBreakdown.length > 0) {
                console.log('üè¶ APPLICATIONS BREAKDOWN:');
                reportData.applicationBreakdown.forEach((app, index) => {
                    console.log(`   ${index + 1}. ${app.applicationName}`);
                    console.log(`      ‚Ä¢ Total Users: ${app.totalUsers}`);
                    console.log(`      ‚Ä¢ Active Requests: ${app.activeRequests}`);
                    console.log(`      ‚Ä¢ Pending Approvals: ${app.pendingApprovals}`);
                    console.log('');
                });
            } else {
                console.log('üìù No application-specific user access data found.');
                console.log('   This might indicate:');
                console.log('   ‚Ä¢ No tickets have been created with BSG application fields');
                console.log('   ‚Ä¢ User management tickets haven\'t been processed yet');
                console.log('   ‚Ä¢ System is ready but waiting for real user access requests\n');
            }
            
            // Detailed user data
            if (reportData.detailedData && reportData.detailedData.length > 0) {
                console.log('üë• USER ACCESS DETAILS:');
                reportData.detailedData.slice(0, 10).forEach((user, index) => {
                    console.log(`   ${index + 1}. User: ${user.namaUser || 'N/A'} (${user.kodeUser || 'N/A'})`);
                    console.log(`      ‚Ä¢ Application: ${user.applicationName}`);
                    console.log(`      ‚Ä¢ Branch: ${user.branch}`);
                    console.log(`      ‚Ä¢ Status: ${user.status}`);
                    console.log(`      ‚Ä¢ Request Date: ${new Date(user.requestDate).toLocaleDateString()}`);
                    console.log('');
                });
                
                if (reportData.detailedData.length > 10) {
                    console.log(`   ... and ${reportData.detailedData.length - 10} more users\n`);
                }
            }
            
        } else {
            console.log('‚ùå Failed to retrieve user access data');
        }
        
    } catch (error) {
        if (error.response) {
            console.log(`‚ùå API Error: ${error.response.status} - ${error.response.data?.message || 'Unknown error'}`);
        } else {
            console.log(`‚ùå Network Error: ${error.message}`);
        }
    }
}

// Generate Application-Specific Reports
async function generateApplicationReports() {
    console.log('\nüîç CHECKING INDIVIDUAL BSG APPLICATIONS');
    console.log('=====================================\n');
    
    const token = createAdminToken();
    const headers = {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    };
    
    // List of BSG applications to check
    const bsgApplications = [
        'OLIBS',
        'XCARD', 
        'BSG QRIS',
        'BSGTouch',
        'TellerApp/Reporting',
        'SMS BANKING',
        'KLAIM',
        'ATM',
        'Operational Extensions'
    ];
    
    for (const app of bsgApplications) {
        try {
            console.log(`üì± Checking application: ${app}`);
            const response = await axios.get(`${baseURL}/api/reports/application-users/${encodeURIComponent(app)}`, { headers });
            
            if (response.status === 200 && response.data.success) {
                const appData = response.data.data;
                console.log(`   ‚úÖ Application found in system`);
                console.log(`   ‚Ä¢ Total Users: ${appData.summary.totalUsers}`);
                console.log(`   ‚Ä¢ Active Users: ${appData.summary.activeUsers}`);
                console.log(`   ‚Ä¢ Pending Users: ${appData.summary.pendingUsers}`);
                console.log(`   ‚Ä¢ Branches Using: ${appData.summary.branches}`);
            } else {
                console.log(`   ‚ö†Ô∏è  No data available`);
            }
        } catch (error) {
            if (error.response && error.response.status === 404) {
                console.log(`   üìù No users found for ${app}`);
            } else {
                console.log(`   ‚ùå Error checking ${app}: ${error.message}`);
            }
        }
        console.log('');
    }
}

// Generate Excel Report
async function generateExcelReport() {
    console.log('üìÑ GENERATING EXCEL REPORT');
    console.log('==========================\n');
    
    const token = createAdminToken();
    const headers = {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    };
    
    try {
        console.log('üîÑ Requesting Excel export...');
        const response = await axios.get(`${baseURL}/api/reports/user-access-summary?format=excel`, { 
            headers,
            responseType: 'arraybuffer'
        });
        
        if (response.status === 200) {
            const filename = `bsg-users-by-applications-${new Date().toISOString().split('T')[0]}.xlsx`;
            const filepath = `/Users/yanrypangouw/Documents/Projects/Web/ticketing-system/backend/${filename}`;
            
            fs.writeFileSync(filepath, response.data);
            
            console.log('‚úÖ Excel report generated successfully!');
            console.log(`üìÅ File saved: ${filepath}`);
            console.log(`üíæ File size: ${response.data.length} bytes`);
            console.log(`üìä Content-Type: ${response.headers['content-type']}`);
            
            return filepath;
        } else {
            console.log(`‚ùå Excel generation failed: ${response.status}`);
        }
    } catch (error) {
        console.log(`‚ùå Excel generation error: ${error.message}`);
    }
}

// Generate Branch Analytics Report
async function generateBranchAnalytics() {
    console.log('\nüè¢ BSG BRANCH ANALYTICS');
    console.log('=====================\n');
    
    const token = createAdminToken();
    const headers = {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    };
    
    try {
        const response = await axios.get(`${baseURL}/api/reports/branch-access-analytics?period=30`, { headers });
        
        if (response.status === 200 && response.data.success) {
            const branchData = response.data.data;
            
            console.log('üìä BRANCH SUMMARY:');
            console.log(`   ‚Ä¢ Total Branches: ${branchData.summary.totalBranches}`);
            console.log(`   ‚Ä¢ CABANG Branches: ${branchData.summary.cabangBranches}`);
            console.log(`   ‚Ä¢ CAPEM Branches: ${branchData.summary.capemBranches}`);
            console.log(`   ‚Ä¢ Total Requests: ${branchData.summary.totalRequests}`);
            console.log(`   ‚Ä¢ Avg Requests per Branch: ${branchData.summary.avgRequestsPerBranch}\n`);
            
            if (branchData.branchMetrics && branchData.branchMetrics.length > 0) {
                console.log('üè¶ TOP BRANCHES BY ACTIVITY:');
                branchData.branchMetrics.slice(0, 5).forEach((branch, index) => {
                    console.log(`   ${index + 1}. ${branch.branchName} (${branch.branchType})`);
                    console.log(`      ‚Ä¢ Total Requests: ${branch.totalRequests}`);
                    console.log(`      ‚Ä¢ User Management: ${branch.userManagementRequests} (${branch.userMgmtPercentage}%)`);
                    console.log(`      ‚Ä¢ Approval Rate: ${branch.approvalRate}%`);
                    console.log('');
                });
            }
        }
    } catch (error) {
        console.log(`‚ùå Branch analytics error: ${error.message}`);
    }
}

// Main execution
async function main() {
    await generateUserAccessSummary();
    await generateApplicationReports();
    const excelFile = await generateExcelReport();
    await generateBranchAnalytics();
    
    console.log('\nüéØ REPORT GENERATION COMPLETE');
    console.log('============================');
    console.log('‚úÖ User access summary generated');
    console.log('‚úÖ Application-specific reports checked');
    console.log('‚úÖ Branch analytics generated');
    if (excelFile) {
        console.log(`‚úÖ Excel report saved: ${excelFile}`);
    }
    console.log('\nüí° To populate the system with user data:');
    console.log('   1. Create tickets using BSG service templates');
    console.log('   2. Fill in application name and user details');
    console.log('   3. Process approval workflows');
    console.log('   4. Re-run this report to see user access tracking');
}

main().catch(error => {
    console.error('‚ùå Report generation failed:', error.message);
    process.exit(1);
});